#textdomain wesnoth-Hero_of_Irdya_I

    # These macros toggle a glyph on the given location on or off
#define GLYPH_ON X Y
    [foreach]
        array=glyphs
        [do]
            [if]
                [variable]
                    name=this_item.x
                    numerical_equals={X}
                [/variable]
                [variable]
                    name=this_item.y
                    numerical_equals={Y}
                [/variable]

                [then]
                    [remove_item]
                        x,y={X},{Y}
                        image=$this_item.image_off
                    [/remove_item]

                    [item]
                        x,y={X},{Y}
                        image=$this_item.image_on
                    [/item]

                    [if]
                        [variable]
                            name=this_item.toggles_x
                            not_equals=$empty
                        [/variable]

                        [then]
                            [sound]
                                name=rumble.ogg
                            [/sound]

                            [terrain]
                                x,y=$this_item.toggles_x,$this_item.toggles_y
                                terrain=Xu
                            [/terrain]
                            [kill]
                                x,y=$this_item.toggles_x,$this_item.toggles_y
                                animate=yes
                                fire_event=yes
                            [/kill]
                        [/then]
                    [/if]
                [/then]
            [/if]
        [/do]
    [/foreach]
#enddef
#define GLYPH_OFF X Y
    [foreach]
        array=glyphs
        [do]
            [if]
                [variable]
                    name=this_item.x
                    numerical_equals={X}
                [/variable]
                [variable]
                    name=this_item.y
                    numerical_equals={Y}
                [/variable]

                [then]
                    [remove_item]
                        x,y={X},{Y}
                        image=$this_item.image_on
                    [/remove_item]

                    [item]
                        x,y={X},{Y}
                        image=$this_item.image_off
                    [/item]

                    [if]
                        [variable]
                            name=this_item.toggles_x
                            not_equals=$empty
                        [/variable]

                        [then]
                            [sound]
                                name=rumble.ogg
                            [/sound]

                            [terrain]
                                x,y=$this_item.toggles_x,$this_item.toggles_y
                                terrain=Cud
                            [/terrain]
                        [/then]
                    [/if]
                [/then]
            [/if]
        [/do]
    [/foreach]
#enddef

[scenario]
    id="12_Caverns_of_Flame"
    name= _ "Caverns of Flame"

    victory_when_enemies_defeated=no

    {SCENARIO_MAP_DATA 1 12_Caverns_of_Flame}
    {NEXT_SCENARIO 13_Thunderstorm}

    turns=70
    {TIME_OVER_DEFEAT}

    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

    {STORY_TEXT_SCENARIO_12}

    # Changed Jahin's flag
    # variant as he is now
    # a commander in the soon-to-be
    # Alliance of Arkenova

    [side]
        side=1
        {CHARACTER_STATS_JAHIN}
        canrecruit=yes
        controller=human
        {FLAG_VARIANT loyalist}
        team_name="good"
        fog=yes
        shroud=yes
        user_team_name= _ "Adventurers"
        {GOLD 280 250 220}
        {INCOME 3 2 1}
    [/side]

    {STARTING_VILLAGES 1 8}

    [side]
        side=2
        controller=ai
        team_name="elementals"
        id="Fire_Leader"
        generate_name=no
        type="Lava Behemoth"
        color=gold
        hidden=yes
        {FLAG_VARIANT ragged}
        {GOLD 200 300 400}
        {INCOME 22 33 44}

        recruit={ON_DIFFICULTY ("Fire Guardian") ("Fire Wisp, Fire Guardian") ("Fire Wisp, Fire Guardian, Fire Ghost")}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.10}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            # there is really no way to reach this guy
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=50.00
            [/goal]
            [goal]
                name=target
                [criteria]
                    id="Jahin"
                [/criteria]
                value=100.00
            [/goal]
        [/ai]
    [/side]

    #ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Fire Wisp" 3}
    #endif
    #ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Fire Ghost" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Fire Wisp" 4}
    #endif

    [side]
        side=3
        controller=ai
        team_name="elementals"
        id="Fire_Leader3"
        generate_name=no
        type="Lava Giant"
        color=yellow
        hidden=yes
        {FLAG_VARIANT ragged}
        {GOLD 60 75 90}
        {INCOME 12 22 34}

        recruit={ON_DIFFICULTY ("Brazier Whelpling, Brazier Imp, Fire Guardian") ("Brazier Whelpling, Brazier Imp, Furnace Beast, Fire Guardian") ("Brazier Whelpling, Brazier Imp, Furnace Beast, Fire Guardian, Fire Wisp")}
        
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.10}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=50.00
            [/goal]
            [goal]
                name=target
                [criteria]
                    id="Jahin"
                [/criteria]
                value=100.00
            [/goal]
        [/ai]
    [/side]

    #ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Furnace Beast" 4}
    #endif
    #ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Furnace Beast" 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Fire Wisp" 4}
    #endif

    [side]
        side=4
        controller=ai
        team_name="elementals"
        id="Fire_Leader4"
        generate_name=no
        # Yes, no mercy
        type="Lava Behemoth"
        color=brightorange
        hidden=yes
        {FLAG_VARIANT ragged}
        {GOLD 60 75 90}
        {INCOME 12 22 34}

        recruit={ON_DIFFICULTY ("Brazier Whelpling, Brazier Imp, Fire Guardian") ("Brazier Whelpling, Brazier Imp, Furnace Beast, Fire Guardian") ("Brazier Whelpling, Brazier Imp, Furnace Beast, Fire Guardian, Fire Wisp")}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.10}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=50.00
            [/goal]
            [goal]
                name=target
                [criteria]
                    id="Jahin"
                [/criteria]
                value=100.00
            [/goal]
        [/ai]
    [/side]

    #ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Furnace Beast" 4}
    #endif
    #ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Furnace Beast" 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Fire Wisp" 4}
    #endif

    # boss and minions side
    [side]
        side=5
        controller=ai
        team_name="elementals"
        hidden=yes
        {NO_ECONOMY}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.10}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=50.00
            [/goal]
            [goal]
                name=target
                [criteria]
                    id="Jahin"
                [/criteria]
                value=100.00
            [/goal]
        [/ai]
    [/side]

    # Prestart
    [event]
        name="prestart"

        {CLEAR_VARIABLE enemies_defeated,image_status,warren_alive,yracyn_eradicated}

        [disallow_recruit]
            side=1
            type="Drake Glider, Drake Fighter"
        [/disallow_recruit]

        [unit]
            side=1
            id="soldier"
            generate_name=yes
            placement=leader
            type="Minotaur Rouser"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        {RECALL "Fah Ra Din"}
        {RECALL "Kojac"}
        {RECALL "Crylix"}
        {RECALL "rider1"}
        {RECALL "rider2"}
        {RECALL "Nog"}
        {RECALL "Sylwester"}
        {RECALL "Loyal_Ghost"}

        # Runes - boss phase

        # copied and adjusted from SoF
        [set_variables]
            name=glyphs

            [value]
                x,y=33,3
                image_off=scenery/rune1.png
                image_on=scenery/rune1-glow.png
            [/value]
            [value]
                x,y=9,8
                image_off=scenery/rune2.png
                image_on=scenery/rune2-glow.png
            [/value]
            [value]
                x,y=47,15
                image_off=scenery/rune3.png
                image_on=scenery/rune3-glow.png
            [/value]
            [value]
                x,y=43,33
                image_off=scenery/rune4.png
                image_on=scenery/rune4-glow.png
            [/value]
            [value]
                x,y=23,34
                image_off=scenery/rune1.png
                image_on=scenery/rune1-glow.png
                #toggles_x=2
                #toggles_y=6
            [/value]
            [value]
                x,y=29,34
                image_off=scenery/rune2.png
                image_on=scenery/rune2-glow.png
                #toggles_x=21
                #toggles_y=24
            [/value]
        [/set_variables]

        [foreach]
            array=glyphs
            [do]
                [item]
                    x,y=$this_item.x,$this_item.y
                    image=$this_item.image_off
                [/item]
            [/do]
        [/foreach]

        {VARIABLE fire_elementals_slain 0}
        {VARIABLE white_sapphire_found no}

        {VARIABLE boss_phase_progress 0}
        {VARIABLE boss_trapped no}

        # tunnels

        [tunnel]
            bidirectional=no
            id=fire_elemental_tunnel
            remove=no
            [source]
                x= 4, 6,10
                y=52,56,52
            [/source]
            [target]
                x=23,19,33,16,11,20,24,11, 7, 9, 2,14,34,18,28,12,21,14,10, 4, 3,16, 8, 6, 9,15,38,47,49,50,41,37,38,37,35,36,18,50,44,33,39,23,28
                y=39,34,35,29,58,57,44,50,50,40,44,32,48,28,40,39,40,32,32,35,28,23,18,12, 3, 3, 9,19,20,26,36,30,27,17,27,23,52,54,59,45,41,13, 6
            [/target]
            [filter]
                side=2
                canrecruit=no
            [/filter]
        [/tunnel]

        # objectives

        [objectives]
            side=1
            silent=no

            [objective]
                description= _ "Find the entrance to the Dwarven city"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL white_sapphire_found equals yes}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Search for any secrets"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL white_sapphire_found equals no}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Defeat the Lava Giant"
                condition="win"
                [show_if]
                    [have_unit]
                        side=3
                        canrecruit=yes
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Defeat the Lava Behemoth"
                condition="win"
                [show_if]
                    [have_unit]
                        side=4
                        canrecruit=yes
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Summon the Guardian of Fire"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL boss_phase_progress less_than_equal_to 2}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Subdue the Guardian of Fire"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 3}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Find some way to leave the chamber"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 4}
                [/show_if]
            [/objective]

            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}
            #[objective]
            #    description= _ "Death of an allied leader"
            #    condition="lose"
            #[/objective]

            [carryover]
                bonus=yes
                carryover_percentage=40
            [/carryover]
        [/objectives]

        {SCATTER_IMAGE (terrain=Uu) 20 "scenery/blood-1.png"}
        {SCATTER_IMAGE (terrain=Uu) 20 "scenery/blood-2.png"}
        {SCATTER_IMAGE (terrain=Uu) 20 "scenery/blood-3.png"}
        {SCATTER_IMAGE (terrain=Ias) 20 "scenery/gore-1.png"}
        {SCATTER_IMAGE (terrain=Ias) 20 "scenery/gore-2.png"}
        {SCATTER_IMAGE (terrain=Uu) 20 "scenery/gore-3.png"}
        {SCATTER_IMAGE (terrain=Ias) 20 "scenery/gore-4.png"}
    [/event]

    # Start event
    [event]
        name="start"

        {PLACE_IMAGE "items/chest-plain-open.png" 17 20}

        {SIMPLE_MESSAGE "soldier" ( _ "Commander Jahin, we have arrived at the Caverns of Flame!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "I see why your people have named it as such. We should proceed onwards. Do you know of any possible threats here?")}

        {SIMPLE_MESSAGE "soldier" ( _ "There are fire elementals always lurking about but legend has it that there is a godlike entity among them. I hope that we do not encounter least it does exist.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "<i>(intrigued)</i> A godlike entity? It must be one of those Lava Behemoths. Nevertheless, it is worth investigating. We might find some treasure.")}
    [/event]

    # Check for all glyph activators in place

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=boss_trapped
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_ON $x1 $y1}

        [fire_event]
            name="six_runes_check"
        [/fire_event]
    [/event]

    # Toggles a glyph off when the player steps off it
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                [not]
                    find_in=glyphs
                [/not]
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=boss_trapped
                boolean_equals=no
            [/variable]

            [have_location]
                x,y=$x2,$y2
                find_in=glyphs
            [/have_location]
        [/filter_condition]

        {GLYPH_OFF $x2 $y2}
    [/event]

    # Toggles a glyph off when the player unit on it dies
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=boss_trapped
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_OFF $x1 $y1}
    [/event]

    # kill elementals
    [event]
        name="die"
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        
        {SIMPLE_MESSAGE "Jahin" ( _ "At least this one shall not harass us anymore.")}

        {VARIABLE_OP boss_phase_progress add 1}
        [if]
            {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 3}
            [then]
                [fire_event]
                    name="boss_fight_activate"
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name="die"
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        {SIMPLE_MESSAGE "Jahin" ( _ "This Lava Behemoth was indeed a powerful foe.")}

        {VARIABLE_OP boss_phase_progress add 1}
        [if]
            {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 3}
            [then]
                [fire_event]
                    name="boss_fight_activate"
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name="die"
        first_time_only=no
        [filter]
            # normally race=elemental
            # would be sufficient
            # but mainline has 
            # Fire Guardian with
            # race=monster
            side=2,3,4
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {VARIABLE_OP fire_elementals_slain add 1}

        [if]
            {VARIABLE_CONDITIONAL fire_elementals_slain numerical_equals {ON_DIFFICULTY 15 22 30}}
            [then]
                {VARIABLE_OP boss_phase_progress add 1}
                [if]
                    {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 3}
                    [then]
                        [fire_event]
                            name="boss_fight_activate"
                        [/fire_event]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    # Boss fight begin!
    [event]
        id="HOI_S12_Caverns_of_Flame_boss_fight"
        name="boss_fight_activate"
        first_time_only=yes

        {THUNDER (
            {GENERIC_UNIT 5 "Aspect of Fire" 26 30}
            {ASSIGN_ID "Guardian_of_Fire"}

            [unit_overlay]
                id="Guardian_of_Fire"
                # placeholder until I find something
                # better
                image="misc/curse.png"
            [/unit_overlay]

            {GENERIC_UNIT 5 "Furnace Beast" 26 30}
            {GENERIC_UNIT 5 {ON_DIFFICULTY "Furnace Beast" "Lava Giant" "Lava Giant"} 26 30}
            {GENERIC_UNIT 5 "Lava Giant" 26 30}
            {GENERIC_UNIT 5 "Furnace Beast" 26 30}

            #ifdef NORMAL
            {GENERIC_UNIT 5 "Lava Giant" 26 30}
            {GENERIC_UNIT 5 "Furnace Beast" 26 30}
            #endif

            #ifdef HARD
            {GENERIC_UNIT 5 "Lava Giant" 26 30}
            {GENERIC_UNIT 5 "Lava Giant" 26 30}
            #endif

            [micro_ai]
                side=2
                ai_type=boss
                action=add

                id="Guardian_of_Fire"
                [filter_location]
                    x,y=19-34,21-35
                [/filter_location]
            [/micro_ai]

            {HOI_S12_GUARDIAN_BOSS_PROTECTORS}
        )}
    [/event]

    # boss fight mechanics
    [event]
        id="boss_heals_from_damage_inflicted_attacker"
        name="attacker_hits"
        first_time_only=no

        [filter_second]
            id="Guardian_of_Fire"
        [/filter_second]

        [heal_unit]
            [filter]
                id="Guardian_of_Fire"
            [/filter]
            amount=$damage_inflicted
            animate=yes
        [/heal_unit]
    [/event]
    [event]
        id="boss_heals_from_damage_inflicted_defender"
        name="defender_hits"
        first_time_only=no

        [filter]
            id="Guardian_of_Fire"
        [/filter]

        [heal_unit]
            [filter]
                id="Guardian_of_Fire"
            [/filter]
            amount=$damage_inflicted
            animate=yes
        [/heal_unit]
    [/event]

    # boss fight hint
    [event]
        name="attack_end"
        first_time_only=yes
        [filter]
            side=1
        [/filter]
        [filter_second]
            id="Guardian_of_Fire"
        [/filter_second]

        [message]
            side=1
            canrecruit=no
            message= _ "Commander, it seems impossible to injure this creature!"
        [/message]

        {SIMPLE_MESSAGE "Jahin" ( _ "We have to find some other way to defeat this collosal giant!")}

        [transient_message]
            caption=_"Boss Scenario Hint"
            message=_"Find Some Way to Trap the Boss."
            transparent=yes
            image="attacks/sword-fire-god.png~BLIT('attacks/frame-fire-god.png')"
            sound=lightning.ogg
        [/transient_message]
    [/event]

    # event to check if the boss
    # and units are all in position
    [event]
        id="HOI_S12_rune_checker_event"
        name="six_runes_check"
        first_time_only=no

        [filter_condition]
            {VARIABLE_CONDITIONAL boss_phase_progress numerical_equals 3}
        [/filter_condition]

        [if]
            [have_unit]
                side=1

                [filter_location]
                    find_in=glyphs
                [/filter_location]

                count=6
            [/have_unit]

            [then]
                [if]
                    [have_unit]
                        id="Guardian_of_Fire"
                        [filter_location]
                            x,y=26,26
                            radius=1
                        [/filter_location]
                    [/have_unit]
                    [then]
                        [fire_event]
                            name="trap_the_boss"
                        [/fire_event]
                    [/then]
                    [else]
                        {SIMPLE_MESSAGE "Jahin" ( _ "I think we can use these rune glyphs some how.")}
                    [/else]
                [/if]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "My glyph is on."
                [/message]

                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    # boss fight end

    [event]
        id="boss_fight_end_HOI_S12"
        name="trap_the_boss"
        
        {VARIABLE_OP boss_phase_progress add 1}

        {EARTHQUAKE (
            [terrain]
                terrain=Qlf
                x=26
                y=28
            [/terrain]
            # Well, yeah
            # if any unit is standing
            # on the collapsing bridge, they die
            [kill]
                x,y=26,28
                animate=yes
            [/kill]
        )}

        [message]
            side=1
            canrecruit=no
            message= _ "Commander, I think we have managed to trap it!"
        [/message]

        {VARIABLE boss_trapped yes}

        {PLACE_IMAGE "items/gohere.png" 21 17}

        {SIMPLE_MESSAGE "Jahin" ( _ "It seems we have trapped this colossal monstrosity. Let us continue with our sojourn!")}

        {HIGHLIGHT_IMAGE 21 17 "misc/goal-highlight.png" "items/gohere.png"}

        [show_objectives]
        [/show_objectives]
    [/event]

    # boss sighted
    {ON_SIGHTING nine 1 (
        id="Guardian_of_Fire"
    ) (
        [message]
            side=1
            canrecruit=no
            message= _ "Yikes! What on Irdya is that thing?!"
        [/message]

        {SCROLL_TO_UNIT ("Guardian_of_Fire")}

        {SIMPLE_MESSAGE "Jahin" ( _ "It seems to be the so called <i>god</i> of the fire elementals.")}

        [message]
            side=1
            canrecruit=no
            message= _ "What are your orders, Commander Jahin?"
        [/message]

        {SIMPLE_MESSAGE "Jahin" ( _ "Since it is impeding our progression, let us find some way to defeat it.")}

        [show_objectives]
        [/show_objectives]
    )}

    # access the hidden chamber
    [event]
        name=enter_hex
        [filter]
            side=1
            x=21
            y=17
        [/filter]
    [/event]

    # moveto/pickup the item of power
    [event]
        name="moveto"
        first_time_only=yes

        [filter]
            side=1
            x,y=17,20
        [/filter]

        {VARIABLE white_sapphire_found yes}

        {SIMPLE_MESSAGE "soldier" ( _ "We have found a luminous white stone, commander.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "It might be something valuable since it was heavily guarded. Hand it over to me. I shall put in my side-pouch")}

        {SIMPLE_MESSAGE "soldier" ( _ "As you wish, commander.")}

    [/event]


    # sacrifice event hint
    # sacrifice event

    # initialise dwarven sides
    # sighted events

    # reached southern edge
    [event]
        name="moveto"
        first_time_only=yes

        [filter]
            id="Jahin"
            x=29-31
            y=61
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL white_sapphire_found equals yes}
        [/filter_condition]

        {SIMPLE_MESSAGE "Jahin" ( _ "This must be the way to the Dwarven capital! Let's hurry and leave this infernal place.")}

        [endlevel]
            result="victory"
            {NEW_GOLD_CARRYOVER 40}
            bonus=yes
        [/endlevel]
    [/event]


#ifdef __UNUSED__
    [side]
        side=2
        id="deathknight"
        generate_name=yes
        type="Death Knight"
        controller=ai
        {FLAG_VARIANT ragged}
        team_name="undead"
        user_team_name= _ "Undead"
        hidden=yes
        gold=-60
        income=18
        recruit="Revenant, Bone Shooter"
    [/side]

    [event]
        name="die"
        first_time_only=no

        [filter]
            id="deathknight"
        [/filter]
        {SCROLL_TO 19 16}

        {EARTHQUAKE (
            {MODIFY_TERRAIN Uu (19,20) (17,17)}
        )}
        {DELAY 500}

        {SIMPLE_MESSAGE "Jahin" ( _ "Ah, killing this abomination seems to have opened a path for us. Onwards!")}

        {SIMPLE_MESSAGE "soldier" ( _ "Commander, this knight was guarding a chamber. Should we investigate it?")}

        {SIMPLE_MESSAGE "Jahin" ( _ "I suppose we should.")}
    [/event]

    [side]
        side=3
        controller=ai
        canrecruit=yes
        id="nightmareboss1"
        generate_name=yes
        type="Death Spectre"
        team_name="evil"
        hidden=yes
        user_team_name= _ "Nightmares"
        {FLAG_VARIANT ragged}
        {GOLD 100 160 240}
        {INCOME 3 4 5}
        recruit="Soul Snatcher, Life Thief, Cloud of Gloom, Howling Darkness, Angry One, Black Cat, Jinx Beast, Rash One, Unhatched, Scornful Watcher, Spiteful Watcher"
    [/side]

    [side]
        side=4
        controller=ai
        canrecruit=yes
        id="dwarf_ally1"
        generate_name=yes
        type="Dwarvish Sentinel"
        {IS_EXPENDABLE_LEADER}
        team_name="good"
        hidden=yes
        user_team_name= _ "Dwarves"
        {FLAG_VARIANT knalgan}
        {GOLD 500 460 340}
        {INCOME 3 4 5}
        recruit=" Dwarvish Steelclad, Dwarvish Fighter, Dwarvish Crossbowman, Dwarvish Thunderer, Dwarvish Scout, Dwarvish Guardsman, Dwarvish Stalwart"
    [/side]

    [side]
        side=5
        controller=ai
        canrecruit=yes
        id="rebel_leader"
        generate_name=yes
        type="Dwarvish Masked Lord"
        team_name="rebels"
        hidden = yes
        user_team_name= _ "Masked Dwarves"
        {FLAG_VARIANT knalgan}
        {GOLD 400 460 540}
        {INCOME 3 4 5}
        recruit=" Dwarvish Masked Steelclad, Dwarvish Masked Fighter, Dwarvish Masked Thunderer, Dwarvish Masked Thunderguard, Dwarvish Masked Guardsman"
    [/side]

    [side]
        side=6
        controller=ai
        canrecruit=yes
        id="nightmareboss2"
        generate_name=yes
        type="Raging One"
        hidden = yes
        team_name="evil"
        user_team_name= _ "Nightmares"
        {FLAG_VARIANT ragged}
        {GOLD 200 260 340}
        {INCOME 3 4 5}
        recruit=" Soul Snatcher, Life Thief, Cloud of Gloom, Howling Darkness, Angry One, Black Cat, Jinx Beast, Rash One, Unhatched, Scornful Watcher, Spiteful Watcher"
    [/side]

    [side]
        side=7
        controller=ai
        canrecruit=yes
        id="nightmareboss3"
        generate_name=yes
        type="Inquisitor"
        hidden = yes
        team_name="evil"
        user_team_name= _ "Nightmares"
        {FLAG_VARIANT ragged}
        {GOLD 200 260 340}
        {INCOME 3 4 5}
        recruit=" Soul Snatcher, Life Thief, Cloud of Gloom, Howling Darkness, Angry One, Black Cat, Jinx Beast, Rash One, Unhatched, Scornful Watcher, Spiteful Watcher"
    [/side]

    [side]
        side=8
        controller=ai
        canrecruit=yes
        id="nightmareboss4"
        generate_name=yes
        type="Calamity"
        hidden = yes
        team_name="evil"
        user_team_name= _ "Nightmares"
        {FLAG_VARIANT ragged}
        {GOLD 100 160 240}
        {INCOME 3 4 5}
        recruit=" Soul Snatcher, Life Thief, Cloud of Gloom, Howling Darkness, Angry One, Black Cat, Jinx Beast, Rash One, Unhatched, Scornful Watcher, Spiteful Watcher"
    [/side]

    [side]
        side=9
        hidden=yes
        no_leader=yes
        controller=ai
        {FLAG_VARIANT long}
        color="orchid"
        team_name="elementals"
        user_team_name= _ "Fire Guardians"
    [/side]

    [event]
        name=prestart

        [objectives]
            side=1
            silent=no

            [objective]
                description= _ "Find the entrance to the Dwarven city"
                condition="win"
            [/objective]
            [objective]
                description= _ "Search for any secrets"
                condition="win"
            [/objective]

            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of an allied leader"
                condition="lose"
            [/objective]

            [carryover]
                bonus=yes
                carryover_percentage=40
            [/carryover]
        [/objectives]

        [disallow_recruit]
            side=1
            type="Drake Glider, Drake Fighter"
        [/disallow_recruit]

        [unit]
            side=1
            id="soldier"
            generate_name=yes
            placement=leader
            type="Minotaur Rouser"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        {RECALL "Fah Ra Din"}
        {RECALL "Kojac"}
        {RECALL "Crylix"}
        {RECALL "rider1"}
        {RECALL "rider2"}
        {RECALL "Nog"}

        [unit]
            side=2
            generate_name=yes
            placement=leader
            {IS_LOYAL}
            type="Draug"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]
        {GUARDIAN}
        [unit]
            side=2
            generate_name=yes
            placement=leader
            {IS_LOYAL}
            type="Draug"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]
        {GUARDIAN}

        {LOYAL_UNIT 2 "Revenant" 28, 30}{GUARDIAN}
        {LOYAL_UNIT 2 "Revenant" 24, 30}{GUARDIAN}
        {LOYAL_UNIT 2 "Revenant" 25, 32}{GUARDIAN}
        {LOYAL_UNIT 2 "Revenant" 27, 32}{GUARDIAN}

        {LOYAL_UNIT 4 "Dwarvish Stalwart" 29 53}{GUARDIAN}
        {LOYAL_UNIT 4 "Dwarvish Stalwart" 31 53}{GUARDIAN}
        {LOYAL_UNIT 4 "Dwarvish Stalwart" 29 56}{GUARDIAN}
        {LOYAL_UNIT 4 "Dwarvish Stalwart" 31 56}{GUARDIAN}
        {LOYAL_UNIT 4 "Dwarvish Stalwart" 28 54}{GUARDIAN}
        {LOYAL_UNIT 4 "Dwarvish Stalwart" 32 54}{GUARDIAN}

        {CLEAR_VARIABLE enemies_defeated,image_status,warren_alive,yracyn_eradicated}

        {VARIABLE white_sapphire_found no}
    [/event]

    {ON_SIGHTING nine 1 (
        race=nightmare
        [or]
            race=aberration
        [/or]
    ) (
        {SIMPLE_MESSAGE "Jahin" ( _ "These abominations are here as well?")}
        {SIMPLE_MESSAGE "soldier" ( _ "Should we engage, commander?")}
        {SIMPLE_MESSAGE "Jahin" ( _ "Avoid them if you can. We cannot waste time here.")}
    )}

    {ON_SIGHTING ten 1 (
        race=dwarf
    ) (
        {SIMPLE_MESSAGE "sighted_unit" ( _ "Who goes there? Friend or foe?")}
        {SIMPLE_MESSAGE "Jahin" ( _ "Friend. Can you take us to your capital?")}
        {SIMPLE_MESSAGE "sighted_unit" ( _ "The way to the metropolis is just south from our outpost.")}
    )}

    {ON_SIGHTING eleven 1 (
        id="dwarf_ally1"
    ) (
        {SIMPLE_MESSAGE "dwarf_ally1" ( _ "Hey, who are you?")}
        {SIMPLE_MESSAGE "Jahin" ( _ "We are envoys sent from the combined forces of Drakes, Trolls and Minotaurs in search of an alliance with your people.")}
        {SIMPLE_MESSAGE "dwarf_ally1" ( _ "Ah, I see. Well, lad, you have arrived at our northern outpost. Take the tunnel south from here.")}
        {SIMPLE_MESSAGE "Jahin" ( _ "Thank you, dwarf. We shall resume our trek then.")}
    )}

    # spawner event

    [event]
        name="turn 5, turn 12, turn 19, turn 26, turn 33, turn 40, turn 47, turn 54, turn 61"
        first_time_only=no

        {GENERIC_UNIT 9 "Fire Wisp"  6  5}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 50 17}{GUARDIAN}
        {GENERIC_UNIT 9 "Fire Wisp" 24  3}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 31 36}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp" 34 32}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp" 20 34}{GUARDIAN}

        {GENERIC_UNIT 9 "Fire Wisp" 26 36}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast"  5 36}{GUARDIAN}
        {GENERIC_UNIT 9 "Fire Wisp" 15 35}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 44 39}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp" 13 41}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp"  5 53}{GUARDIAN}

        {GENERIC_UNIT 9 "Fire Wisp" 10 58}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 10 52}{GUARDIAN}
        {GENERIC_UNIT 9 "Fire Wisp" 14 60}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 22 56}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp" 47 58}{GUARDIAN}
        {GENERIC_UNIT 9 "Brazier Imp" 49 54}{GUARDIAN}

        {GENERIC_UNIT 9 "Fire Wisp" 33 41}{GUARDIAN}
        {GENERIC_UNIT 9 "Furnace Beast" 33 45}{GUARDIAN}
    [/event]

    # taking the white sapphire

    [event]
        name="moveto"
        first_time_only=yes

        [filter]
            side=1
            x,y=26,26
        [/filter]

        {VARIABLE white_sapphire_found yes}

        {SIMPLE_MESSAGE "soldier" ( _ "We have found a luminous white stone, commander.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "It might be something valuable since it was heavily guarded. Hand it over to me. I shall put in my side-pouch")}

        {SIMPLE_MESSAGE "soldier" ( _ "As you wish, commander.")}

        [objectives]
            side=1
            silent=no

            [objective]
                description= _ "Find the entrance to the Dwarven city"
                condition="win"
            [/objective]

            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of an allied leader"
                condition="lose"
            [/objective]

            [carryover]
                bonus=yes
                carryover_percentage=40
            [/carryover]
        [/objectives]
    [/event]

    [event]
        name="moveto"
        first_time_only=no

        [filter]
            id="Jahin"
            x=29-31
            y=61
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL white_sapphire_found equals yes}
            [then]
                {SIMPLE_MESSAGE "Jahin" ( _ "This must be the way to the dwarven capital! Let's hurry and leave this infernal place.")}

                [endlevel]
                    result="victory"
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=yes
                [/endlevel]
            [/then]
            [else]
                {SIMPLE_MESSAGE "Jahin" ( _ "I don't think we should leave just yet.")}
            [/else]
        [/if]
    [/event]
#endif

    {MAIN_HERO_DEATH_EVENTS}
    {KOJAC_LOYAL_DEATH_EVENT}
    {LOYAL_UNIT_DEATH_EVENT}

    {XP_GAINING_EVENT_JAHIN_SIDE}
    {RECALL_COST_CHANGE}
    {~add-ons/Hero_of_Irdya_I/macros/global-events.cfg}
[/scenario]

#undef GLYPH_ON
#undef GLPYH_OFF
