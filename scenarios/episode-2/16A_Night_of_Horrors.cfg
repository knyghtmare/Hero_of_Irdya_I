#textdomain wesnoth-Hero_of_Irdya_I

[scenario]
    id="16A_Night_of_Horrors"
    name= _ "Night of Horrors"

    victory_when_enemies_defeated=no

    {SCENARIO_MAP_DATA 2 16A_Night_of_Horrors}
    {NEXT_SCENARIO 17A_Amidst_the_Sands}

    {TURNS 32 30 28}
    {TIME_OVER_DEFEAT}

    # perpetually night
    {MIDNIGHT}

    {STORY_TEXT_SCENARIO_16}

    [side]
        side=1
        {CHARACTER_STATS_JAHIN}
        canrecruit=yes
        controller=human
        {FLAG_VARIANT loyalist}
        team_name="good"
        user_team_name= _ "Verdanyn"
        fog=yes
        shroud=yes
        share_vision=all
        {GOLD 350 300 280}
        {INCOME 3 2 1}
    [/side]

    {STARTING_VILLAGES 1 6}

    [side]
        side=2
        id="Enemy_Commander"
        generic_name=yes
        canrecruit=yes
        controller=ai
        hidden=yes
        hitpoints={ON_DIFFICULTY 120 150 180}
        max_hitpoints={ON_DIFFICULTY 120 150 180}
        type="Darkspawn Lord"
        {FLAG_VARIANT undead}
        team_name="evil"
        user_team_name= _ "Evil"
        {GOLD 1400 1600 1900}
        {INCOME 18 21 25}

        recruit="Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Unhatched, Black Cat, Jinx Beast, Angry One, Rash One, Scornful Watcher, Spiteful Watcher, Life Thief, Soul Snatcher, Howling Darkness, Cloud of Gloom"
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.00}
            {AI_SIMPLE_ALWAYS_ASPECT leader_value 20.00}
            [goal]
                name=target
                [criteria]
                    id="Jahin"
                [/criteria]
                value=10
            [/goal]
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=5
            [/goal]
        [/ai]

        [ai]
            [engine]
                name="lua"
                code= <<
                    return wesnoth.require("ai/micro_ais/engines/priority_target_engine.lua").init()
                >>
            [/engine]
            [modify_ai]
                side=2
                action=add
                # wmllint: unbalanced-on
                path=stage[main_loop].candidate_action[]
                # wmllint: unbalanced-off
                [candidate_action]
                    engine=lua
                    name=change_attacks_aspect
                    id=change_attacks_aspect
                    max_score=999999
                    evaluation="return (...):change_attacks_aspect('Alynoic')"
                    execution="(...):change_attacks_aspect()"
                [/candidate_action]
            [/modify_ai]
        [/ai]
    [/side]

    {STARTING_VILLAGES 2 7}

    [side]
        side=3
        id="Alynoic"
        name= _ "female^Alynoic"
        gender=female
        type="Great Mage"
        canrecruit=yes
        controller=ai
        shroud=yes
        fog=yes
        share_vision=none
        {FLAG_VARIANT long}
        team_name="good"
        user_team_name= _ "The Academy"
        recruit="Brazier Imp, Furnace Beast, Fire Wisp, Kobold, Stone Golem, Razorbird, Thunderbird, Wisp, Ethereal Orb, Sylph, Zephyr, Ice Crab, Tidal, Undine, Mage, White Mage, Red Mage"
        village_gold=1
        {INCOME 40 38 36}
        {GOLD 400 380 360}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.20}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.80}
        [/ai]
    [/side]

    {STARTING_VILLAGES 3 9}

    [event]
        name="last breath"

        [filter]
            id="Alynoic"
        [/filter]

        {SIMPLE_MESSAGE "unit" ( _ "With my death, the Academy falls!")}
    [/event]

    [event]
        name="die"

        [filter]
            id="Alynoic"
        [/filter]

        {ENDLEVEL_DEFEAT}
    [/event]

    [side]
        side=4
        id="Orc_Chief16"
        generic_name=yes
        canrecruit=yes
        controller=ai
        type="Orcish Warlord"
        {FLAG_VARIANT ragged}

        team_name="orcs"
        user_team_name= _ "Northerners"

        {GOLD 600 800 1200}
        {INCOME 13 18 23}

        recruit="Ogre, Orcish Raider, Orcish Warrior, Orcish Crossbowman, Orcish Slayer, Orcish Pyro Archer, Goblin Lancer, Goblin Pillager, Goblin Knight"
    [/side]

    {STARTING_VILLAGES 4 6}

    [side]
        side=5
        team_name="good"
        user_team_name= _ "Woodlanders"
        id="Woodlander_Leader"
        generic_name=yes
        type="Faun Lord"
        canrecruit=yes
        controller=ai
        fog=yes
        shroud=yes
        share_vision=none
        {IS_EXPENDABLE_LEADER}
        {FLAG_VARIANT wood-elvish}
        recruit="Faun Marksman, Faun Captain, Golem, Young Sasquatch, Elfin, Rodent Rider, Toxic Plant, Banebush, Wose, Faerie Sprite"
        {GOLD 520 500 500}
        {INCOME 22 18 13}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.66}
            {AI_SIMPLE_ALWAYS_ASPECT leader_value 0.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.33}

            [goal]
                name=protect_unit
                [criteria]
                    id="Woodlander_Leader"
                [/criteria]
                protect_radius=8
                value=5
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 5 10}

    [side]
        side=6
        id="Enemy_Commander2"
        generic_name=yes
        canrecruit=yes
        controller=ai
        hidden=yes
        type="Ancient Dark Wose"
        {FLAG_VARIANT undead}
        team_name="evil"
        user_team_name= _ "Evil"
        {GOLD 100 150 250}
        {INCOME 8 11 15}

        recruit="Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Unhatched, Black Cat, Jinx Beast, Angry One, Rash One, Scornful Watcher, Spiteful Watcher, Life Thief, Soul Snatcher, Howling Darkness, Cloud of Gloom, Elder Dark Wose, Dark Wose"
    [/side]

    [side]
        side=7
        id="Ally_leader1"
        generic_name=yes
        {IS_EXPENDABLE_LEADER}
        type="Elder Mage"
        canrecruit=yes
        controller=ai
        {FLAG_VARIANT long}
        team_name="good"
        hidden=yes
        user_team_name= _ "The Academy"
        recruit="Stone Golem, Kobold, Vine Beast, Vine Tiger"
        {GOLD 80 120 150}
        {INCOME 8 11 15}
    [/side]

    [side]
        side=8
        id="Ally_leader2"
        generic_name=yes
        {IS_EXPENDABLE_LEADER}
        type="Mage of Storms"
        canrecruit=yes
        controller=ai
        {FLAG_VARIANT long}
        team_name="good"
        hidden=yes
        user_team_name= _ "The Academy"
        recruit="Razorbird, Sylph, Zephyr, Thunderbird"
        {GOLD 80 120 150}
        {INCOME 8 11 15}
    [/side]

    # side 9

    [side]
        side=9
        no_leader=yes
        controller=ai
        color=khaki
        team_name="good"
        user_team_name= _ "Verdanyn"
        fog=yes
        shroud=yes
        share_vision=all
        {FLAG_VARIANT loyalist}

        #ifdef EASY
        recruit="Outlaw, Axeman, Trapper, Bandit, Huntress, Thug, Poacher, Footpad, Tracker"
        #endif
        #ifdef NORMAL
        recruit="Outlaw, Axeman, Huntress, Thug, Poacher, Footpad, Tracker"
        #endif
        #ifdef HARD
        recruit="Thug, Axethrower, Poacher, Footpad, Tracker"
        #endif

        {GOLD 150 120 80}
        # I just want the side to 'exist'
        {INCOME 18 13 8}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.33}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.66}

            # This AI shall have three goals
            # Ensure base is protected
            # Ensure their leader is stays safe
            # Ensure their hero unit stays safe

            [goal]
                name=protect_location
                [criteria]
                    x,y=39,74
                [/criteria]
                protect_radius=16
                value=5
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    id="Mahir"
                [/criteria]
                protect_radius=8
                value=5
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    id="Meherab"
                [/criteria]
                protect_radius=8
                value=5
            [/goal]
        [/ai]
    [/side]

    # preload

    [event]
        name=preload
        first_time_only=no
        # Lua function to prioritise 
        # higher level units
        [lua]
            code=<<
                function high_level_unit(unit)
                    if (unit.level >= 2) then
                        return true
                    else
                        return false
                    end
                end
            >>
        [/lua]
    [/event]

    # prestart

    [event]
        name="prestart"

        {RECALL "Abrar"}
        {RECALL "Mahir"}
        {RECALL "Meherab"}

        # Oh, a lot of loyal units
        # almost a pre-recalled
        # army
        {RECALL "Fah Ra Din"}
        {RECALL "Kojac"}
        {RECALL "Crylix"}
        {RECALL "rider1"}
        {RECALL "rider2"}
        {RECALL "Nog"}
        {RECALL "soldier"}
        {RECALL "soldier2"}
        {RECALL "Varawiel"}
        {RECALL "Sylwester"}
        {RECALL "Loyal_Ghost"}

        {SCATTER_UNITS {ON_DIFFICULTY 45 60 75} "Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Unhatched, Black Cat, Jinx Beast, Angry One, Rash One, Scornful Watcher, Spiteful Watcher, Life Thief, Soul Snatcher, Howling Darkness, Cloud of Gloom" 5 (
            terrain=Gg
            x= 1-75
            y=20-75

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=2
            generate_name=yes
            random_traits=yes
        )}

        {SCATTER_UNITS {ON_DIFFICULTY 20 25 30} "Furnace Beast, Fire Wisp, Stone Golem, Zephyr, Vine Tiger, Vine Beast, Brazier Imp, Kobold, Sylph, Razorbird, Thunderbird" 5 (
            terrain=Gg
            x=21-75
            y=9-27

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=3
            generate_name=yes
            random_traits=yes
        )}

        {SCATTER_UNITS {ON_DIFFICULTY 40 35 32} "Faun Marksman, Faun Captain, Golem, Young Sasquatch, Sasquatch, Elfin, Rodent Rider, Rodent Predator, Toxic Plant, Banebush, Wose, Elder Wose, Faerie Sprite, Fire Faerie" 5 (
            terrain=Gs^Ft
            x= 1-75
            y=36-75

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=5
            generate_name=yes
            random_traits=yes
        )}

        {SCATTER_UNITS {ON_DIFFICULTY 32 38 45} "Orcish Grunt, Orcish Raider, Orcish Warrior, Orcish Archer, Orcish Crossbowman, Orcish Pyro Archer, Orcish Shaman, Orcish Warlock, Orcish Assassin, Orcish Slayer, Young Ogre, Ogre, Goblin Impaler, Goblin Spearmaster, Goblin Rouser, Goblin Cavalry, Goblin Lancer, Goblin Knight, Wolf Rider, Goblin Pillager" 5 (
            terrain=Gg
            x=21-75
            y=19-61

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=4
            generate_name=yes
            random_traits=yes
        )}

        {LOYAL_UNIT 4 "Orcish Juggernaut"  9 31}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 4 "Orcish Warrior"  5 31}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 4 "Orcish Slurbow" 10 30}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 4 "Orcish Elite Warrior" 13 30}{HOI_IMPROVED_GUARDIAN}

        {LOYAL_UNIT 3 "Lava Giant"  7 10}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Lava Giant"  9 10}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Lava Giant"  6 11}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Lava Giant" 10 11}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Lava Giant"  7 13}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Lava Giant"  9 13}{HOI_IMPROVED_GUARDIAN}

        {LOYAL_UNIT 3 "Stone Golem" 38  5}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 40  6}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 39  7}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 42  7}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 44  8}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 45  8}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 46  9}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 46 11}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 45 10}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 45 16}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 46 14}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 45 14}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 43 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 42 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 42 16}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 40 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 38 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 35 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 34 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 33 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 30 17}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 27 18}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 26 17}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 24 15}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 22 14}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 21 13}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 21 11}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 21 8}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 26 6}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 28 5}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Stone Golem" 31  5}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 3 "Furnace Beast" 34  4}{HOI_IMPROVED_GUARDIAN}

        {LOYAL_UNIT 5 "Elder Wose"  5 71}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 5 "Elder Wose"  3 72}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 5 "Elder Wose"  3 74}{HOI_IMPROVED_GUARDIAN}
        {LOYAL_UNIT 5 "Elder Wose"  7 73}{HOI_IMPROVED_GUARDIAN}

        # micro AI

        [micro_ai]
            side=2
            ai_type=fast_ai
            action=add
            dungeon_mode=no
        [/micro_ai]
        [micro_ai]
            side=2
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=fast_ai
            action=add
            dungeon_mode=no
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=fast_ai
            action=add
            dungeon_mode=no
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]

        [micro_ai]
            side=3
            ai_type=zone_guardian
            action=add

            [filter]
                side=3
                canrecruit=no
            [/filter]
            [filter_location]
                x=24-42
                y=7-17
                terrain=G*,R*,C*,K*,*^V*
            [/filter_location]
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=simple_attack
            action=add

            ca_score=110001
            [filter_second]
                side=2
            [/filter_second]
        [/micro_ai]
        

        [micro_ai]
            side=6
            ai_type=zone_guardian
            action=add

            [filter]
                side=6
                canrecruit=no
            [/filter]
            [filter_location]
                x=27-42
                y=66-75
                terrain=G*,R*,C*,K*,*^V*
            [/filter_location]
        [/micro_ai]
        [micro_ai]
            side=6
            ai_type=simple_attack
            action=add

            ca_score=110001
            [filter_second]
                lua_function = "high_level_unit"
            [/filter_second]
        [/micro_ai]

        {VARIABLE scenario_16_phase 1}
        {VARIABLE turns_until_phase_three {ON_DIFFICULTY 4 4 3}}
        {VARIABLE jahin_has_keep yes}
    [/event]

    # counter which activates after phase 2 is reached
    [event]
        name="new turn"
        first_time_only=no

        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 2}
        [/filter_condition]

        {VARIABLE_OP turns_until_phase_three sub 1}

        [if]
            {VARIABLE_CONDITIONAL turns_until_phase_three numerical_equals 0}
            [then]
                {VARIABLE_OP scenario_16_phase add 1}

                [fire_event]
                    name="arrival_of_evil"
                [/fire_event]
            [/then]
        [/if]
    [/event]

    # start

    [event]
        name="start"

        {SIMPLE_MESSAGE "Jahin" ( _ "What is going on here? We seemed to have arrived at a battlefield.")}

        {SIMPLE_MESSAGE "Mahir" ( _ "This certainly explains why reinforcements haven't been coming to us. They have been getting beset by aberrants and undead.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "I am a bit puzzled right now. These lands were firmly under alliance control. How did so many of these malicious creatures get here?")}

        {SIMPLE_MESSAGE "Meherab" ( _ "I do not know. I think I should investigate the vicinity. Maybe head to the Academy to see what is going on? They may know something.")}

        {SIMPLE_MESSAGE "Mahir" ( _ "I shall rally the troops. Many of us have decided to join you in this excursion.")}

        # transfer Mahir and Meherab to side 9

        {MOVE_UNIT (id="Mahir") 39 74}
        {MOVE_UNIT (id="Meherab") 36 73}

        {MODIFY_UNIT (id="Meherab") side 9}

        # Can I do this in one line?
        # {MODIFY_UNIT (id="Mahir") canrecruit,side yes,9}
        # Or, should I just leave it like this to
        # just play it safe?

        # Meherab dies pretty easily if exposed 
        # which his AI seems to do quite
        # frequently
        {MODIFY_UNIT (id="Meherab") hitpoints {ON_DIFFICULTY 180 160 140}}
        {MODIFY_UNIT (id="Meherab") max_hitpoints {ON_DIFFICULTY 180 160 140}}

        {MODIFY_UNIT (id="Mahir") side 9}
        {MODIFY_UNIT (id="Mahir") canrecruit yes}

        # Please, just stay the fuck
        # inside your keep!!!
        [micro_ai]
            side=9
            ai_type=hang_out
            action=add
            ca_score=500000
            ca_id=mahir_stays_inside_keep

            [filter]
                id="Mahir"
            [/filter]
            [filter_location]
                x,y=39,74
                radius=2
            [/filter_location]
            [mobilize_condition]
                {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 2}
            [/mobilize_condition]
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=hang_out
            action=add
            ca_score=500000
            ca_id=alynoic_stays_inside_keep

            [filter]
                id="Alynoic"
            [/filter]
            [filter_location]
                x,y=8,11
                radius=2
            [/filter_location]
            [mobilize_condition]
                {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 3}
            [/mobilize_condition]
        [/micro_ai]

        # some starting units for Mahir and Meherab

        [repeat]
            times={ON_DIFFICULTY 6 5 4}
            [do]
                [set_variable]
                    name=army_type
                    rand=Outlaw, Trapper, Huntress, Axeman, Bandit, Rogue
                [/set_variable]
                {GENERIC_UNIT 9 $army_type 36 73}
                {GENERIC_UNIT 9 $army_type 39 74}

                {CLEAR_VARIABLE army_type}
            [/do]
        [/repeat]

        # micro AI for meherab
        # to prevent him for doing something
        # suicidal

        # result: this is an effing joke
        # please fix this MAI

        #[micro_ai]
        #    side=9
        #    ai_type=protect_unit
        #    action=add
        #    ca_id=meherab_escort_function
        #    ca_score=400000
        #    [unit]
        #        id="Meherab"
        #        goal_x,goal_y=26,12
        #    [/unit]
        #[/micro_ai]
        [micro_ai]
            side=9
            ai_type=messenger_escort
            action=add

            # our messenger
            id="Meherab"
            ca_id=meherab_escort_function
            ca_score=400000
            # our escorts
            [filter_second]
                side=9
                canrecruit=no
            [/filter_second]
            # maybe make him
            # rest at a village
            # which fall along his path?
            waypoint_x=26
            waypoint_y=12
        [/micro_ai]

        [micro_ai]
            side=9
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]

        {SIMPLE_MESSAGE "Jahin" ( _ "Abrar, are you ready for this?")}

        {SIMPLE_MESSAGE "Abrar" ( _ "If it means I get to eat as many peanuts as I want afterwards, I am always ready!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "Let us trek northwards then. To the Academy!")}

        [objectives]
            side=1
            silent=no

            [objective]
                description= _ "Acertain what is happening"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 1}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Escort Meherab to the Academy (26,12)"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 1}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Protect Mahir"
                condition="win"
            [/objective]
            [objective]
                description= _ "Escort Mauni to safety (31,74)"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 2}
                [/show_if]
            [/objective]
            [objective]
                caption= _ "Optional Objective:"
                description= _ "Escort Mauni to safety (31,74)"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 3}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Meherab stays alive"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 2}
                [/show_if]
            [/objective]
            [objective]
                caption= _ "Bonus:"
                description= _ "Keep three mages (except Mauni) alive"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 2}
                [/show_if]
            [/objective]
            [objective]
                caption= _ "Bonus:"
                description= _ "Keep three mages (except Mauni) alive"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_16_phase equals 3}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any hero unit"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any non-expendable allied leader"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [carryover]
                bonus=yes
                carryover_percentage=30
            [/carryover]

            [note]
                description= _ "Mahir will be busy defending the home base."
            [/note]
            [note]
                description= _ "Do not leave Mahir unguarded."
            [/note]
            [note]
                description= _ "Recalling units with the <i>chaotic</i> alignment is recommended."
            [/note]
            [note]
                description= _ "Jahin and Abrar should not be near the Academy."
            [/note]
        [/objectives]
    [/event]

    {MAIN_HERO_DEATH_EVENTS}
    {MAHIR_DEATH_EVENT}
    {KOJAC_LOYAL_DEATH_EVENT}
    {LOYAL_UNIT_DEATH_EVENT}

    # event when side 2 attacks

    [event]
        name="attack"

        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {SIMPLE_MESSAGE "Jahin" ( _ "Defensive stances, everyone! Do not let the enemy circumvent our ranks!")}
    [/event]

    [event]
        name="attack"

        [filter]
            side=2
            race=vampire
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {SIMPLE_MESSAGE "Jahin" ( _ "Vampires?! Obliterate them at once!")}
    [/event]

    # Woodlanders spawn if enemies capture a village
    # This doesn't trigger for side 1

    [event]
        name=capture
        first_time_only=no

        [filter]
            [filter_location]
                x=1-75
                y=40-75
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=unit.side
                numerical_equals=5
            [/variable]
            [then]
                {CLEAR_VARIABLE cleared_$x1|_$y1|_village}
            [/then]
            [else]
                [if]
                    [variable]
                        name=cleared_$x1|_$y1|_village
                        not_equals=yes
                    [/variable]
                    [then]
                        [set_variable]
                            name=cleared_$x1|_$y1|_village
                            value=yes
                        [/set_variable]

                        [if]
                            [variable]
                                name=unit.side
                                numerical_equals=1
                            [/variable]
                            [then]
                                [set_variable]
                                    name=indigs
                                    rand=0
                                [/set_variable]
                            [/then]
                            [else]
                                [set_variable]
                                    name=indigs
                                    rand=2..4
                                [/set_variable]
                            [/else]
                        [/if]

                        [set_variable]
                            name=indig_countdown
                            value=$indigs
                        [/set_variable]
                        [while]
                            [variable]
                                name=indig_countdown
                                greater_than=0
                            [/variable]
                            [do]
                                [store_locations]
                                    [filter_adjacent_location]
                                        x,y=$x1,$y1
                                    [/filter_adjacent_location]

                                    [not]
                                        [filter]
                                        [/filter]
                                    [/not]

                                    variable=possible_indig_locations
                                [/store_locations]

                                [if]
                                    [variable]
                                        name=possible_indig_locations.length
                                        greater_than=0
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP random_location_index rand "1..$possible_indig_locations.length"}
                                        [set_variable]
                                            name=random_location_index
                                            sub=1
                                        [/set_variable]
                                        {RANDOM (Faun,Young Sasquatch,Golem,Elfin)}
                                        [unit]
                                            type=$random
                                            side=5
                                            x,y=$possible_indig_locations[$random_location_index].x,$possible_indig_locations[$random_location_index].y
                                            generate_name=yes
                                            random_traits=yes
                                        [/unit]
                                    [/then]
                                [/if]
                                [set_variable]
                                    name=indig_countdown
                                    sub=1
                                [/set_variable]
                            [/do]
                        [/while]
                        {CLEAR_VARIABLE indigs_countdown}

                        {CLEAR_VARIABLE possible_indig_locations}
                        {CLEAR_VARIABLE indigs}
                    [/then]

                    [else]
                        [allow_undo]
                        [/allow_undo]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    # enemy wave spawner
    # I am wondering if this is too much...

    [event]
        name="new turn"
        first_time_only=no

        [filter_condition]
            [lua]
                code=<< return (wesnoth.get_variable("turn_number")%4 == 0)  >>
            [/lua]
        [/filter_condition]

        {FADE_TO_BLACK}

        [set_variable]
            name=wave_type
            rand=undead,nightmares,invaders,vampires,devlings,night_horrors
        [/set_variable]
        
        [switch]
            variable=wave_type

            [case]
                value=nightmares

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Unhatched, Black Cat, Jinx Beast, Angry One, Rash One, Scornful Watcher, Spiteful Watcher, Life Thief, Soul Snatcher, Howling Darkness, Cloud of Gloom, Dark Wose, Elder Dark Wose" 5 (
                    terrain=Gg
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]
            [case]
                value=night_horrors

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Darkspawn Lord, Shadow, Nightgaunt, Nightmare Bat" 5 (
                    terrain=Gg
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]
            [case]
                value=invaders

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Darkspawn, Darkspawn Invader, Darkspawn Spearman, Darkspawn Impaler, Darkspawn Warrior, Unhatched, Black Cat, Jinx Beast, Angry One, Rash One, Scornful Watcher, Spiteful Watcher, Life Thief, Soul Snatcher, Howling Darkness, Cloud of Gloom, Dark Wose, Elder Dark Wose" 5 (
                    terrain=Gg
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]
            [case]
                value=undead

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Revenant, Bone Shooter, Deathblade, Necrophage, Shadow, Wraith, Chocobone, Skeleton, Skeleton Archer, Skeleton Rider, Bone Knight, Deathmaster, Initiate, Lich" 5 (
                    terrain=Gg
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]
            [case]
                value=vampires

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Vampire Duelist, Half Blood, Thin Blood, Vampire Noble, Flesh Artisan, Fledgeling, Blood Hulk, Vampiric Dread Bat, Vampiric Blood Bat, Blood Apprentice, Blood Manipulator, Mistress, Sire, Sword Dancer" 5 (
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]

            [case]
                value=devlings

                {SCATTER_UNITS {ON_DIFFICULTY 25 30 35} "Devling Flappers, Devling Flyers, Devling Nailers, Devling Spikers, Overgrown Devling, Devling Soldier, Devling Warrior, Devling Sneak, Devling Lurker, Devling Ninja, Devling Cursers, Devling Blasphemists" 5 (
                    terrain=Gg
                    x= 1-75
                    y=20-75

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=2
                    generate_name=yes
                    random_traits=yes
                )}
            [/case]

        [/switch]
        {CLEAR_VARIABLE wave_type}

        {FADE_IN}

        # gold to evil side
        [gold]
            side=2
            amount={ON_DIFFICULTY 320 400 500}
        [/gold]

        [if]
            {VARIABLE_CONDITIONAL turn_number numerical_equals 4}
            [then]
                {SIMPLE_MESSAGE "Mahir" ( _ "What on Irdya just happened?! Everthing just went dark and now, we have more of these abominations and aberrants to deal with.")}

                {SIMPLE_MESSAGE "Jahin" ( _ "Oh, no! We have been caught off guard! Brace yourselves! Here they come!")}
            [/then]
            [elseif]
                {VARIABLE_CONDITIONAL turn_number numerical_equals 12}
                [then]
                    {SIMPLE_MESSAGE "Meherab" ( _ "Even more of them have appeared!")}

                    {SIMPLE_MESSAGE "Mahir" ( _ "Meherab, fasten your pace! We cannot hold off the hordes forever!")}
                [/then]
            [/elseif]
        [/if]
    [/event]

    # orc side gets gold
    # as battle rages on

    [event]
        name="new turn"
        first_time_only=no

        [filter_condition]
            [lua]
                code=<< return (wesnoth.get_variable("turn_number")%8 == 0)  >>
            [/lua]
        [/filter_condition]

        [gold]
            side=4
            amount={ON_DIFFICULTY 200 320 440}
        [/gold]
        # Side 5 also gets some
        # gold to ensure a constant combat flow
        [gold]
            side=5
            amount={ON_DIFFICULTY 100 160 220}
        [/gold]
    [/event]

    # sighted events

    {ON_SIGHTING twelve 1 (
        side=6
    ) (
        {SIMPLE_MESSAGE "Meherab" ( _ "Jahin, enemies ahead!")}
        {SIMPLE_MESSAGE "Jahin" ( _ "Dispatch them swifty!")}
    )}

    {ON_SIGHTING fourteen 1 (
        race=darkspawn
    ) (
        {SIMPLE_MESSAGE "Abrar" ( _ "What are these things?")}
        {SIMPLE_MESSAGE "Jahin" ( _ "They do not appear to be friendly. Kill them.")}
    )}

    {ON_SIGHTING fifteen 1 (
        race=devling
    ) (
        {SIMPLE_MESSAGE "Jahin" ( _ "Those tiny creatures seem belligerent.")}
        {SIMPLE_MESSAGE "Abrar" ( _ "Excellent! More things to smash!")}
    )}

    {ON_SIGHTING thirteen 1 (
        side=4
    ) (
        {SIMPLE_MESSAGE "Jahin" ( _ "Orcs and Goblins are here as well? This is going to be a long night.")}
    )}

    # side 6 leader death

    [event]
        name="die"

        [filter]
            id="Enemy_Commander2"
        [/filter]

        {SIMPLE_MESSAGE "Mahir" ( _ "Hehe, that was easy!")}

        {SIMPLE_MESSAGE "Meherab" ( _ "Don't drop your guard yet. We got more enemies ahead!")}
    [/event]

    [event]
        name="moveto"
        first_time_only=yes
        id="trigger_investigation_event"

        [filter]
            side=1
            [filter_adjacent]
                side=5
            [/filter_adjacent]
            [or]
                side=5
                [filter_adjacent]
                    side=1
                [/filter_adjacent]
            [/or]
        [/filter]

        {SIMPLE_MESSAGE "Jahin" ( _ "Umm, hello! Do you know what is going on here?")}

        {UNIT_MESSAGE (side,canrecruit=5,no) ( _ "We were just defending our forests from an orc warband when suddenly all these abominations and aberrants appeared out of nowhere.")}

        {UNIT_MESSAGE (side,canrecruit=5,no) ( _ "Please help us!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "We are heading to the Academy to investigate the phenomenon. We shall ensure to eliminate any enemy in our path.")}
    [/event]

    # phase 2 of scenario
    [event]
        name="escape_the_academy"
        first_time_only=yes

        {VARIABLE_OP scenario_16_phase add 1}

        {SCROLL_TO  8 11}
        {DELAY 500}

        [remove_shroud]
            side=1
            x=5-12
            y=10-14
        [/remove_shroud]

        [lift_fog]
            [filter_side]
                side=1
            [/filter_side]
            x=5-12
            y=10-14
            multi_turn=no
        [/lift_fog]

        {SIMPLE_MESSAGE "Alynoic" ( _ "Wait a minute...You're those boys! Jahin, Meherab and Mahir!")}

        {SIMPLE_MESSAGE "Meherab" ( _ "It is nice to see you again, Lady Alynoic! Can you tell us what is happening here?")}

        {SIMPLE_MESSAGE "Alynoic" ( _ "A fortnight ago, these aberrants have started attacking us and they have been relentless so far. Our defences are strong however, I fear we may not be able to withstand them for long.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "How can we help? We are no friends of these abominations and their activity here is detrimental to the alliance activities.")}

        {SIMPLE_MESSAGE "Alynoic" ( _ "It may be too much to ask this, but can you take the young students and flee? The rest of us shall remain here and hold off the enemy's advance.")}

        {SIMPLE_MESSAGE "Jahin" ( _ "There must be another way!")}

        {SIMPLE_MESSAGE "Alynoic" ( _ "There is not. You must flee.")}

        [unit]
            side=9
            x,y=26,13
            type={ON_DIFFICULTY "Cleric" "White Mage" "Adept of Light"}
            gender=female
            id="Mauni"
            name=_"female^Mauni"
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TRAIT_HARDY}
            [/modifications]
            {IS_HERO}
        [/unit]

        {GENERIC_UNIT 9 "Mage" 26 13}{ASSIGN_ID "mage01"}
        {GENERIC_UNIT 9 "Thunder Mage" 26 13}{ASSIGN_ID "mage02"}
        {GENERIC_UNIT 9 "Wood Mage" 26 13}{ASSIGN_ID "mage03"}

        [micro_ai]
            side=9
            ai_type=hang_out
            action=add
            ca_score=500000
            ca_id=meherab_stays_behind

            [filter]
                side=9
                canrecruit=no
                [not]
                    id="Mauni"
                [/not]
                [not]
                    id="mage01"
                [/not]
                [not]
                    id="mage02"
                [/not]
                [not]
                    id="mage03"
                [/not]
            [/filter]
            [filter_location]
                x,y=26,12
                radius=2
            [/filter_location]
            [mobilize_condition]
                {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 3}
            [/mobilize_condition]
        [/micro_ai]

        [micro_ai]
            side=9
            ai_type=messenger_escort
            action=add

            # our messenger
            id="Mauni"
            ca_id=mauni_escort_function
            ca_score=400000
            # our escorts
            [filter_second]
                id="mage01","mage02","mage03"
            [/filter_second]
            waypoint_x=31
            waypoint_y=74
        [/micro_ai]

        [place_shroud]
            side=1
            x=5-12
            y=10-14
        [/place_shroud]

        [reset_fog]
            [filter_side]
                side=1
            [/filter_side]
            x=5-12
            y=10-14
        [/reset_fog]


        {SIMPLE_MESSAGE "Mauni" ( _ "Please help us escape!")}
        
        {SIMPLE_MESSAGE "Meherab" ( _ "Jahin, you must escort them to safety! The rest and I shall stay here and hold them off!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "Meherab, this is suicide!")}

        {SIMPLE_MESSAGE "Mahir" ( _ "Don't be a fool, Meherab! Join them as they retreat! You don't need to die here!")}

        {SIMPLE_MESSAGE "Meherab" ( _ "No, some of us have to stay and keep the enemies attention here!")}

        {SIMPLE_MESSAGE "Abrar" ( _ "I shall always remember you as a hero. Farewell, my friend!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "Alright! You have heard him! Form a defensive formation! We are escorting these mages to safety!")}

        # make him some sort of allied boss
        [modify_unit]
            [filter]
                id="Meherab"
            [/filter]
            hitpoints={ON_DIFFICULTY 120 110 100}
            max_hitpoints={ON_DIFFICULTY 120 110 100}
        [/modify_unit]

        [show_objectives]
        [/show_objectives]
    [/event]

    # meherab reaches his goal
    # triggers phase 2
    [event]
        name="moveto"
        first_time_only=yes
        [filter]
            id="Meherab"
            x=26
            y=12
        [/filter]

        [micro_ai]
            side=9
            ai_type=messenger_escort
            action=delete
            ca_id=meherab_escort_function
        [/micro_ai]

        [fire_event]
            name="escape_the_academy"
        [/fire_event]
    [/event]

    # jahin no longer recruits
    [event]
        name="recruit,recall"
        first_time_only=no
        [filter]
            side=1
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL jahin_has_keep not_equals no}
        [/filter_condition]

        [if]
            [have_unit]
                side=1
                # I have no clue how many the player
                # should have at start since 
                # I lost a few loyal units
                # in some scenarios and started this with 5 loyal units
                count={ON_DIFFICULTY 26 24 22}
            [/have_unit]
            [then]
                {VARIABLE jahin_has_keep no}
                {MODIFY_TERRAIN "Ce" 31 74}
                {SIMPLE_MESSAGE "Jahin" ( _ "I think that I have rallied enough of my troops and I should personally join them on the field.")}
            [/then]
            #[else]
            #    [lua]
            #        code=<< chat_jahin(...) >>
            #        [args]
            #            txt_msg = _ "I can still recall/recruit some units before leaving my keep."
            #        [/args]
            #    [/lua]
            #[/else]
        [/if]
    [/event]

    # event to prevent premature death
    # of allied leader

    [event]
        name="attack"
        first_time_only=no
        [filter_second]
            id="Alynoic"
        [/filter_second]

        {LOYAL_UNIT 2 "Lava Behemoth" $x1 $y1}
        {LOYAL_UNIT 2 "Lava Behemoth" $x1 $y1}
        {LOYAL_UNIT 2 "Lava Behemoth" $x1 $y1}

        {LOYAL_UNIT 2 {ON_DIFFICULTY "Lava Behemoth" "Lava Giant" "Lava Giant"} $x1 $y1}
        {LOYAL_UNIT 2 {ON_DIFFICULTY "Lava Behemoth" "Lava Giant" "Lava Giant"} $x1 $y1}
        {LOYAL_UNIT 2 {ON_DIFFICULTY "Lava Behemoth" "Lava Giant" "Lava Giant"} $x1 $y1}
    [/event]

    # death events for main escort
    [event]
        name="last breath"
        [filter]
            id="Mauni"
        [/filter]

        {SIMPLE_MESSAGE "Mauni" ( _ "Oh, no! Do not let me die!")}
    [/event]

    [event]
        name=die
        [filter]
            id="Mauni"
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 2}
        [/filter_condition]

        {SIMPLE_MESSAGE "Mahir" ( _ "How could you let her die? I was planning to court her!")}

        {ENDLEVEL_DEFEAT}
    [/event]

    [event]
        name=die
        [filter]
            id="Mauni"
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_16_phase numerical_equals 3}
        [/filter_condition]

        {SIMPLE_MESSAGE "Mahir" ( _ "How could you let her die? I was planning to court her!")}

        # hidden event
        [disallow_recruit]
            side=1
            type="Adept of Light"
        [/disallow_recruit]

        {SIMPLE_MESSAGE "Jahin" ( _ "How could we have let such a thing transpire? Now, our Adepts of Light refuse to follow us anymore!")}

        [lua]
            code=<< chat_jahin(...) >>
            [args]
                txt_msg = _ "I can no longer recruit Adepts of Light anymore."
            [/args]
        [/lua]

        {MODIFY_UNIT (id="Mahir") side 1}
        {MODIFY_UNIT (id="Mahir") canrecruit no}

        # storing him since I shall be giving the player
        # the option of play his side mission later
        [store_unit]
            [filter]
                id="Mahir"
            [/filter]
            kill=yes
            fire_event=no
            variable="stored_hero.Mahir"
        [/store_unit]

        # 10% carried over for failing the scenario
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 10}
            bonus=yes
        [/endlevel]
    [/event]

    # optional win event
    [event]
        name="moveto"
        first_time_only=yes
        [filter]
            side=9
            id="Mauni"
            x,y=31,74
        [/filter]

        {SIMPLE_MESSAGE "Mauni" ( _ "Thank you for ensuring our safety!")}
        [kill]
            id="Mauni"
            animate=no
        [/kill]

        [if]
            [have_unit]
                id="mage01"
            [/have_unit]
            [then]
                [kill]
                    id="mage01"
                    animate=no
                [/kill]

                [lua]
                    code=<< chat_jahin(...) >>
                    [args]
                        txt_msg = _ "A Mage has been added to your recall list."
                    [/args]
                [/lua]

                {GENERIC_UNIT 1 "Mage" recall recall}
            [/then]
        [/if]
        [if]
            [have_unit]
                id="mage02"
            [/have_unit]
            [then]
                [kill]
                    id="mage02"
                    animate=no
                [/kill]

                [lua]
                    code=<< chat_jahin(...) >>
                    [args]
                        txt_msg = _ "A Thunder Mage has been added to my recall list."
                    [/args]
                [/lua]

                {GENERIC_UNIT 1 "Thunder Mage" recall recall}
            [/then]
        [/if]
        [if]
            [have_unit]
                id="mage03"
            [/have_unit]
            [then]
                [kill]
                    id="mage03"
                    animate=no
                [/kill]

                [lua]
                    code=<< chat_jahin(...) >>
                    [args]
                        txt_msg = _ "A Wood Mage has been added to my recall list."
                    [/args]
                [/lua]

                {GENERIC_UNIT 1 "Wood Mage" recall recall}
            [/then]
        [/if]

        # storing him since I shall be giving the player
        # the option of play his side mission later
        [store_unit]
            [filter]
                id="Mahir"
            [/filter]
            kill=yes
            fire_event=no
            variable="stored_hero.Mahir"
        [/store_unit]

        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 20}
            bonus=yes
        [/endlevel]
    [/event]

    #phase3

    [event]
        name="arrival_of_evil"
        id="S16A_phase_three"
        first_time_only=yes

        {FADE_TO_BLACK}

        {PLAY_SOUND dwarf-laugh.wav}
        {MYS_MSG ( _ "Vaddyn, my former apprentice...Why do you resist?")}
        
        {SIMPLE_MESSAGE "Mahir" ( _ "<i>(fearful)</i> Who on Irdya said that?")}

        {SIMPLE_MESSAGE "Abrar" ( _ "Why is everything suddenly so dark? I cannot see anything!")}

        {SIMPLE_MESSAGE "Jahin" ( _ "What is going on? That voice is echoing everywhere!")}

        {MYS_MSG ( _ "You know that...there is no point in hiding...I am ending this pathetic world...")}

        {MYS_MSG ( _ "However, I have not forgetten what you did, dear Vaddyn...that is why I had focused so many of limitless forces on your precious little Academy...")}

        {MYS_MSG ( _ "I grow tired of this war of attrition. Let me bring you to me.")}

        {SIMPLE_MESSAGE "Mahir" ( _ "What did that voice just say?")}

        {THUNDER (
            [replace_map]
                map_file=specials/16A_Night_of_Horrors_2.map
                expand=yes
                shrink=yes
            [/replace_map]
        )}
        #[terrain_mask]
        #    x,y=1,1
        #    mask={~add-ons/Hero_of_Irdya_I/maps/specials/16A_Night_of_Horrors_2.map}
        #    alignment=raw
        #[/terrain_mask]

        [kill]
            [filter_location]
                terrain="Qxu"
            [/filter_location]
            fire_event=no
            animate=no
        [/kill]

        {FADE_IN}

        {SIMPLE_MESSAGE "Abrar" ( _ "What on Irdya?")}

        {SIMPLE_MESSAGE "Jahin" ( _ "Where is Meherab? More importantly, where is the Academy?")}

        {SIMPLE_MESSAGE "Mahir" ( _ "It seems to have been...teleported somewhere? I can feel traces of an immensely powerful teleportation spell however, my magic cannot seem to access it...")}

        {SIMPLE_MESSAGE "Jahin" ( _ "I speculate that we should do what we can right now.")}

        {SIMPLE_MESSAGE "Mahir" ( _ "Aye. Let us continue with escorting the mages to safety.")}

        # make AI target side 1's escort

        # actually I am concerned
        # whether this would work
        # given we have the fast micro AI
        # active
        [modify_ai]
            side=2
            action=add
            # wmllint: unbalanced-on
            path=stage[main_loop].candidate_action[]
            # wmllint: unbalanced-off
            [candidate_action]
                engine=lua
                name=change_attacks_aspect
                id=change_attacks_aspect
                max_score=999999
                evaluation="return (...):change_attacks_aspect('Mauni')"
                execution="(...):change_attacks_aspect()"
            [/candidate_action]
        [/modify_ai]

        [show_objectives]
        [/show_objectives]
    [/event]

    # nightmare bat
    [event]
        name="attack"
        first_time_only=yes
        [filter]
            type="Nightmare Bat"
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {SIMPLE_MESSAGE "Mahir" ( _ "That bat just appeared out of nowhere!")}
    [/event]

    {~add-ons/War_of_Legends/macros/curse-global-events.cfg}
    {XP_GAINING_EVENT_JAHIN_SIDE}
    {RECALL_COST_CHANGE}
    {~add-ons/Hero_of_Irdya_I/macros/global-events.cfg}
[/scenario]
